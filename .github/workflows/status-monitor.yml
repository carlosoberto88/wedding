name: GitHub Actions Status Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes
  workflow_dispatch:  # Allows manual triggering

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Axios
        run: npm install axios

      - name: Check GitHub Actions Status
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          node <<EOF
          const axios = require('axios');

          async function sendToSlack(message) {
            try {
              await axios.post(process.env.SLACK_WEBHOOK_URL, {
                text: message,
                username: 'GitHub Actions Monitor',
                icon_emoji: ':octocat:',
              });
            } catch (error) {
              console.error('Error sending to Slack:', error.message);
            }
          }

          async function checkStatus() {
            try {
              // Notify that monitoring is starting
              await sendToSlack('ðŸ” Testing GitHub Actions monitoring setup...');

              // Check GitHub Actions Status
              const response = await axios.get(
                'https://www.githubstatus.com/api/v2/components/8c1bd9c4-9d00-4ac3-8526-7761af0f7620.json'
              );

              const { status, description, updated_at: updatedAt } = response.data.component;

              const statusEmoji = {
                operational: 'âœ…',
                degraded_performance: 'âš ï¸',
                partial_outage: 'ðŸš¨',
                major_outage: 'âŒ',
              };

              const emoji = statusEmoji[status] || 'â“';

              const message = `GitHub Actions: ${emoji} ${status.replace('_', ' ').toUpperCase()}
Description: ${description}
Last Updated: ${new Date(updatedAt).toLocaleString()}`;

              await sendToSlack(message);
            } catch (error) {
              console.error('Error checking GitHub Actions status:', error);
              await sendToSlack(`:x: Error checking GitHub Actions status: ${error.message}`);
            }
          }

          checkStatus();
          EOF
